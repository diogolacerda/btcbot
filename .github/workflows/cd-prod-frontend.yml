# CD Prod Frontend - Deploy manual para ambiente de producao
#
# Trigger: Manual via workflow_dispatch
# Acao: Build da imagem Docker frontend e push para Docker Hub com tags:
#   - latest (sempre atualizada em cada deploy)
#   - prod-<sha> (rastreabilidade por commit)
#   - v<version> (versao semantica, se disponivel)
#
# O Watchtower no homeserver monitora a tag :latest e atualiza
# automaticamente o container btcbot-frontend-prod quando detecta mudanca.
#
# IMPORTANTE: Este workflow deve ser executado APENAS apos validacao completa
# no ambiente de Stage. Producao usa TRADING_MODE=live com fundos reais.
#
# Porta: 3200 (frontend-prod)
# Documentacao: /docs/GITFLOW.md

name: CD Prod Frontend

on:
  # Deploy manual - requer aprovacao explicita
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (optional, e.g., v1.2.3)'
        required: false
        type: string

# Apenas um deploy de prod por vez
concurrency:
  group: cd-prod-frontend
  cancel-in-progress: false

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/btcbot-frontend

jobs:
  confirm-deployment:
    name: Confirm Production Deployment
    runs-on: [self-hosted, linux, docker]
    steps:
      - name: Deployment confirmation
        run: |
          echo "=========================================="
          echo "üö® PRODUCTION DEPLOYMENT FRONTEND üö®"
          echo "=========================================="
          echo "Target: Production environment (live trading)"
          echo "Port: 3200"
          echo "URL: http://192.168.68.99:3200"
          echo ""
          echo "‚ö†Ô∏è  CHECKLIST BEFORE PROCEEDING:"
          echo "  ‚úì Stage environment tested and validated"
          echo "  ‚úì All CI checks passed"
          echo "  ‚úì Frontend functionality verified"
          echo "  ‚úì Backend API compatibility confirmed"
          echo "  ‚úì Environment variables reviewed"
          echo ""
          echo "Proceeding with production deployment..."
          echo "=========================================="

  build-and-push-prod:
    name: Build and Push Prod Frontend Image
    runs-on: [self-hosted, linux, docker]
    needs: confirm-deployment

    # Permissoes minimas necessarias
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
        # Buildx permite builds mais eficientes com cache


      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Tag fixa 'latest' - sempre atualizada
            type=raw,value=latest
            # Tag com SHA para rastreabilidade (prod-abc1234)
            type=sha,prefix=prod-
            # Tag de versao semantica, se fornecida
            type=raw,value=${{ github.event.inputs.version }},enable=${{ github.event.inputs.version != '' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Cache otimizado: usa imagem existente no registry + cache local
          cache-from: |
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            type=local,src=/tmp/.buildx-cache-frontend
          cache-to: type=inline
          # Build para amd64 (compativel com homeserver)
          platforms: linux/amd64

      - name: Print deployment info
        run: |
          echo "=========================================="
          echo "‚úÖ CD Prod Frontend - Deploy Completed"
          echo "=========================================="
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          echo "Tags pushed:"
          echo "${{ steps.meta.outputs.tags }}" | tr ',' '\n' | sed 's/^/  - /'
          echo ""
          echo "Watchtower will automatically update btcbot-frontend-prod container"
          echo "Production Frontend URL: http://192.168.68.99:3200"
          echo ""
          echo "üéØ Next steps:"
          echo "  1. Monitor Watchtower logs for container update"
          echo "  2. Verify application health at http://192.168.68.99:3200"
          echo "  3. Check application logs for errors"
          echo "  4. Monitor trading activity (LIVE MODE)"
          echo "=========================================="
